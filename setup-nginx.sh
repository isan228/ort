#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Nginx Ð´Ð»Ñ ORT Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: sudo ./setup-nginx.sh your-domain.com

set -e

DOMAIN=$1

if [ -z "$DOMAIN" ]; then
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð´Ð¾Ð¼ÐµÐ½"
    echo "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: sudo ./setup-nginx.sh ort.kg"
    exit 1
fi

echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx Ð´Ð»Ñ Ð´Ð¾Ð¼ÐµÐ½Ð°: $DOMAIN"

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx
NGINX_CONFIG="/etc/nginx/sites-available/ort"

sudo tee $NGINX_CONFIG > /dev/null <<EOF
server {
    listen 80;
    server_name $DOMAIN www.$DOMAIN;

    # Ð›Ð¾Ð³Ð¸
    access_log /var/log/nginx/ort-access.log;
    error_log /var/log/nginx/ort-error.log;

    # ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
    client_max_body_size 10M;

    # API Ð¿Ñ€Ð¾ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
    location /api {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
        
        # Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ñ‹
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Ð¡Ñ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ React
    location / {
        root /var/www/ort/client/build;
        try_files \$uri \$uri/ /index.html;
        expires 30d;
        add_header Cache-Control "public, immutable";
        
        # Gzip ÑÐ¶Ð°Ñ‚Ð¸Ðµ
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
    }

    # Ð¡Ñ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð±ÐµÐ· ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
    location ~* \.(html|json)$ {
        root /var/www/ort/client/build;
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # Ð‘Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº ÑÐºÑ€Ñ‹Ñ‚Ñ‹Ð¼ Ñ„Ð°Ð¹Ð»Ð°Ð¼
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}
EOF

echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð°"

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ ÑÑÑ‹Ð»ÐºÐ¸ (Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ)
if [ -f "/etc/nginx/sites-enabled/ort" ]; then
    echo "â„¹ï¸  ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑƒÐ¶Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°"
else
    sudo ln -s /etc/nginx/sites-available/ort /etc/nginx/sites-enabled/
    echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°"
fi

# Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð´ÐµÑ„Ð¾Ð»Ñ‚Ð½Ð¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)
if [ -f "/etc/nginx/sites-enabled/default" ]; then
    read -p "Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð´ÐµÑ„Ð¾Ð»Ñ‚Ð½ÑƒÑŽ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Nginx? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        sudo rm /etc/nginx/sites-enabled/default
        echo "âœ… Ð”ÐµÑ„Ð¾Ð»Ñ‚Ð½Ð°Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð°"
    fi
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx..."
sudo nginx -t

if [ $? -eq 0 ]; then
    echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð²Ð°Ð»Ð¸Ð´Ð½Ð°"
    
    # ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Nginx
    echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Nginx..."
    sudo systemctl reload nginx
    
    echo ""
    echo "âœ… Nginx Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
    echo ""
    echo "ðŸ“‹ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
    echo "1. Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚ ÑÐ¾Ð±Ñ€Ð°Ð½: cd /var/www/ort/client && npm run build"
    echo "2. Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ ÑÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½: pm2 status"
    echo "3. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ SSL: sudo certbot --nginx -d $DOMAIN"
    echo ""
else
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx!"
    exit 1
fi

