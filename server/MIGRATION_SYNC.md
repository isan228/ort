# Синхронизация базы данных после git pull

## Проблема

После `git pull` на сервере код обновился, но структура базы данных не синхронизирована. 
В таблице `Users` отсутствуют колонки: `coins`, `referralCode`, `referredBy`.
В таблице `Subscriptions` отсутствует колонка: `discountAmount`.

## Решение: Синхронизация через sync-db.js

### Шаг 1: Подключитесь к серверу

```bash
ssh user@your-server
```

### Шаг 2: Перейдите в папку проекта

```bash
cd /var/www/ort
```

### Шаг 3: Примените синхронизацию базы данных

```bash
cd server
node sync-db.js alter
```

Этот скрипт:
- ✅ Добавит недостающие колонки (`coins`, `referralCode`, `referredBy` в `Users`)
- ✅ Добавит недостающие колонки (`discountAmount` в `Subscriptions`)
- ✅ Создаст новые таблицы, если они отсутствуют (Universities, Specialties, MonthlyRanking)
- ✅ Обновит структуру существующих таблиц
- ⚠️ **НЕ удалит** существующие данные
- ⚠️ **НЕ удалит** существующие колонки

### Шаг 4: Перезапустите сервер

```bash
pm2 restart ort-server
```

### Шаг 5: Проверьте логи

```bash
pm2 logs ort-server --lines 50
```

## Альтернативный способ (если sync-db.js не работает)

Если по какой-то причине `sync-db.js` не работает, можно временно включить автоматическую синхронизацию:

1. Отредактируйте `server/.env`:
   ```env
   AUTO_SYNC_DB=true
   ```

2. Перезапустите сервер:
   ```bash
   pm2 restart ort-server
   ```

3. После успешной синхронизации **обязательно отключите** автоматическую синхронизацию:
   ```env
   AUTO_SYNC_DB=false
   ```

4. Перезапустите сервер еще раз:
   ```bash
   pm2 restart ort-server
   ```

## Что делает `alter: true`?

- ✅ Добавляет новые колонки
- ✅ Изменяет типы колонок (если возможно)
- ✅ Добавляет новые индексы
- ⚠️ **НЕ удаляет** колонки (для безопасности)
- ⚠️ **НЕ изменяет** существующие данные

## Проверка после синхронизации

Проверьте, что колонки добавлены:

```bash
psql -U ort_user -d ort_testing -c "\d Users"
```

Должны быть видны колонки:
- `coins` (integer)
- `referralCode` (varchar)
- `referredBy` (uuid)

