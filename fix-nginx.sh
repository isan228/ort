#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π Nginx
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: sudo ./fix-nginx.sh

set -e

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π Nginx..."
echo ""

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ort
if [ ! -f "/etc/nginx/sites-available/ort" ]; then
    echo "‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ort –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    echo "üí° –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é: sudo ./setup-nginx.sh ort.kg"
    exit 1
fi

# 2. –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ort
if [ ! -L "/etc/nginx/sites-enabled/ort" ]; then
    echo "üìù –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ort..."
    sudo ln -s /etc/nginx/sites-available/ort /etc/nginx/sites-enabled/
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞"
else
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ort —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞"
fi

# 3. –£–¥–∞–ª–µ–Ω–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
if [ -f "/etc/nginx/sites-enabled/default" ]; then
    echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
    sudo rm /etc/nginx/sites-enabled/default
    echo "‚úÖ –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞"
else
    echo "‚úÖ –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É–∂–µ —É–¥–∞–ª–µ–Ω–∞"
fi

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞
echo ""
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞..."
if [ ! -f "/var/www/ort/client/build/index.html" ]; then
    echo "‚ö†Ô∏è  –ö–ª–∏–µ–Ω—Ç –Ω–µ —Å–æ–±—Ä–∞–Ω!"
    echo "üí° –°–æ–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç:"
    echo "   cd /var/www/ort/client"
    echo "   npm run build"
    echo ""
    read -p "–°–æ–±—Ä–∞—Ç—å –∫–ª–∏–µ–Ω—Ç —Å–µ–π—á–∞—Å? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        cd /var/www/ort/client
        npm run build
        echo "‚úÖ –ö–ª–∏–µ–Ω—Ç —Å–æ–±—Ä–∞–Ω"
    else
        echo "‚ö†Ô∏è  –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ —Å–±–æ—Ä–∫–∏..."
    fi
else
    echo "‚úÖ –ö–ª–∏–µ–Ω—Ç —Å–æ–±—Ä–∞–Ω (index.html –Ω–∞–π–¥–µ–Ω)"
    ls -lh /var/www/ort/client/build/index.html
fi

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."
sudo nginx -t

if [ $? -eq 0 ]; then
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∞–ª–∏–¥–Ω–∞"
    
    # 6. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx
    echo ""
    echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx..."
    sudo systemctl reload nginx
    
    echo ""
    echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
    echo ""
    echo "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:"
    echo "   http://ort.kg"
    echo ""
    echo "üí° –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –≤–∏–¥–Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞:"
    echo "   1. –û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞ (Ctrl+F5)"
    echo "   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: sudo nginx -T | grep 'server_name'"
    echo "   3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: sudo tail -f /var/log/nginx/ort-error.log"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx!"
    exit 1
fi

